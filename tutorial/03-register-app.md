---
ms.openlocfilehash: 0c9c6703a54e50f576a171a4a161305c9b9ae6ff
ms.sourcegitcommit: 57a5c2e1a562d8af092a3e78786d711ce1e8f9cb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/30/2020
ms.locfileid: "48822727"
---
<!-- markdownlint-disable MD002 MD041 -->

この手順では、Azure Active Directory 管理センターを使用して、次の3つの新しい Azure AD アプリケーションを作成します。

- シングルページアプリケーションのアプリ登録。これにより、ユーザーはサインインし、トークンを取得して、アプリケーションが Azure 関数を呼び出せるようになります。
- Microsoft Graph を呼び出せるようにするトークンについて、 [オンプレフロー](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow) を使用して SPA によって送信されたトークンを交換できるようにする Azure 関数のアプリ登録。
- Azure 関数 webhook のアプリ登録。これにより、 [クライアント資格情報フロー](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow) を使用して、ユーザーなしで Microsoft Graph を呼び出せるようになります。

> [!NOTE]
> この例では、送信側フローとクライアント資格情報フローの両方を実装しているため、3つのアプリ登録が必要です。 Azure 関数がこれらのフローのいずれかのみを使用する場合は、そのフローに対応するアプリの登録のみを作成する必要があります。

1. ブラウザーを開き、 [Azure Active Directory 管理センター](https://aad.portal.azure.com) に移動して、Microsoft 365 テナントの組織管理者を使用してログインします。

1. 左側のナビゲーションで **[Azure Active Directory]** を選択し、それから **[管理]** で **[アプリの登録]** を選択します。

    ![アプリの登録のスクリーンショット ](./images/aad-portal-app-registrations.png)

## <a name="register-an-app-for-the-single-page-application"></a>シングルページアプリケーション用のアプリを登録する

1. **[新規登録]** を選択します。 **[アプリケーションを登録]** ページで、次のように値を設定します。

    - `Graph Azure Function Test App` に **[名前]** を設定します。
    - **サポートされているアカウントの種類** は、 **この組織ディレクトリのアカウント** に対してのみ設定します。
    - [ **リダイレクト URI** ] で、ドロップダウンを [ **シングルページアプリケーション (SPA)** ] に変更し、値をに設定し `http://localhost:8080` ます。

    ![[アプリケーションを登録する] ページのスクリーンショット](./images/register-command-line-app.png)

1. **[登録]** を選択します。 [ **Graph Azure 関数テストアプリ** ] ページで、 **アプリケーション (クライアント) id** と **ディレクトリ (テナント) id** の値をコピーして保存します。そのためには、後の手順で必要になります。

    ![新しいアプリ登録のアプリケーション ID のスクリーンショット](./images/aad-application-id.png)

## <a name="register-an-app-for-the-azure-function"></a>Azure 関数用のアプリを登録する

1. [ **アプリの登録** ] に戻り、[ **新しい登録** ] を選択します。 **[アプリケーションを登録]** ページで、次のように値を設定します。

    - `Graph Azure Function` に **[名前]** を設定します。
    - **サポートされているアカウントの種類** は、 **この組織ディレクトリのアカウント** に対してのみ設定します。
    - **リダイレクト URI** を空白のままにします。

1. **[登録]** を選択します。 [ **Graph Azure 関数** ] ページで、 **アプリケーション (クライアント) ID** の値をコピーして保存します。そのためには、次の手順で必要になります。

1. **[管理]** で **[証明書とシークレット]** を選択します。 
            **[新しいクライアント シークレット]** ボタンを選択します。 **[説明]** に値を入力して、 **[有効期限]** のオプションのいずれかを選び、 **[追加]** を選択します。

    ![[クライアントシークレットの追加] ダイアログのスクリーンショット](./images/aad-new-client-secret.png)

1. このページを離れる前に、クライアント シークレットの値をコピーします。 次の手順で行います。

    > [!IMPORTANT]
    > このクライアント シークレットは今後表示されないため、この段階で必ずコピーするようにしてください。

    ![新規追加されたクライアント シークレットのスクリーンショット](./images/aad-copy-client-secret.png)

1. [ **管理** ] で、[ **API のアクセス許可** ] を選択します。 [ **アクセス許可の追加** ] を選択します。

1. [ **Microsoft Graph** ]、[委任された **アクセス許可** ] の順に選択します。 メールを追加し **ます。読み取り** 、[ **アクセス許可の追加** ] を選択します。

    ![Azure 関数アプリの登録に対して構成されているアクセス許可のスクリーンショット](./images/web-api-configured-permissions.png)

1. [ **Manage** ] の下にある [ **API を公開する** ] を選択し、[ **範囲の追加** ] を選択します。

1. 既定の **アプリケーション ID URI** をそのまま使用し、[ **保存して続行** ] を選択します。

1. [ **範囲の追加** ] フォームに次のように入力します。

    - **スコープ名:** メールを読み取ります。
    - **同意できるユーザー:** 管理者とユーザー
    - **管理者の同意の表示名:** すべてのユーザーの受信トレイの読み取り
    - **管理者の同意の説明:** アプリですべてのユーザーの受信トレイを読み取ることができるようにします。
    - **ユーザー同意の表示名:** 受信トレイの読み取り
    - **ユーザーの同意の説明:** アプリで受信トレイを読み取ることができるようにします。
    - **状態:** い

1. **[スコープの追加]** を選択します。

1. 新しい範囲をコピーします。これは後の手順で必要になります。

    ![Azure 関数アプリの登録で定義されているスコープのスクリーンショット](./images/web-api-defined-scopes.png)

1. [ **管理** ] の下の [ **マニフェスト** ] を選択します。

1. マニフェスト内を見つけて、 `knownClientApplications` の現在の値を `[]` に置き換え `[TEST_APP_ID]` ます。ここで、 `TEST_APP_ID` は、 **Graph Azure 関数テストアプリ** の登録のアプリケーション ID です。 **[保存]** を選択します。

> [!NOTE]
> テストアプリケーションのアプリ ID を `knownClientApplications` Azure 関数のマニフェストのプロパティに追加すると、テストアプリケーションは、組み合わせられた [同意フロー](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow#default-and-combined-consent)を開始することができます。 これは、その代わりのフローが動作するために必要です。

## <a name="add-azure-function-scope-to-test-application-registration"></a>アプリケーション登録のテストに Azure 関数スコープを追加する

1. **Graph Azure 関数テストアプリ** の登録に戻り、[ **管理** ] の下にある [ **API アクセス許可** ] を選択します。 [ **アクセス許可を追加** ] を選択します。

1. [ **My api** ] を選択し、[ **さらに読み込む** ] を選択します。 **Graph Azure 関数** を選択します。

    ![[API アクセス許可の要求] ダイアログのスクリーンショット](./images/test-app-add-permissions.png)

1. [ **メール] 読み取り** アクセス許可を選択し、[ **アクセス許可の追加** ] を選択します。

1. [ **構成済みのアクセス許可** ] で、ユーザーを削除 **します。** アクセス許可の右側にある [ **.** ..] を選択して [ **削除] アクセス** 許可を選択することにより、 **Microsoft Graph** の下の [読み取り] アクセス許可を選択します。 [ **はい、削除** ] を選択して確定します。

    ![テストアプリのアプリ登録に対して構成されているアクセス許可のスクリーンショット](./images/test-app-configured-permissions.png)

## <a name="register-an-app-for-the-azure-function-webhook"></a>Azure 関数 webhook のアプリを登録する

1. [ **アプリの登録** ] に戻り、[ **新しい登録** ] を選択します。 **[アプリケーションを登録]** ページで、次のように値を設定します。

    - `Graph Azure Function Webhook` に **[名前]** を設定します。
    - **サポートされているアカウントの種類** は、 **この組織ディレクトリのアカウント** に対してのみ設定します。
    - **リダイレクト URI** を空白のままにします。

1. **[登録]** を選択します。 [ **Graph Azure 関数 webhook** ] ページで、 **アプリケーション (クライアント) ID** の値をコピーして保存します。次の手順で必要になります。

1. **[管理]** で **[証明書とシークレット]** を選択します。 
            **[新しいクライアント シークレット]** ボタンを選択します。 **[説明]** に値を入力して、 **[有効期限]** のオプションのいずれかを選び、 **[追加]** を選択します。

1. クライアント シークレットの値をコピーしてから、このページから移動します。 次の手順で行います。

1. [ **管理** ] で、[ **API のアクセス許可** ] を選択します。 [ **アクセス許可の追加** ] を選択します。

1. [ **Microsoft Graph** ]、[ **アプリケーションのアクセス許可** ] の順に選択します。 [ **ユーザー** の追加 **] を選び、[****アクセス許可の追加** ] を選択します。

1. [ **構成済みのアクセス許可** ] で、委任されたユーザーを削除 **します。** アクセス許可の右側にある [ **.** ..] を選択し、[ **削除] アクセス** 許可を選択して、 **Microsoft Graph** の下にある読み取りアクセス許可 [ **はい、削除** ] を選択して確定します。

1. [ **管理者の同意を許可** する] ボタンを選択し、[ **はい** ] を選択して、構成されたアプリケーションのアクセス許可に対する管理者の同意を付与します。 [構成された **アクセス許可** ] テーブルの [ **状態** ] 列が [許可] に変更され **ます** 。

    ![管理者の同意が付与された webhook に対して構成されたアクセス許可のスクリーンショット](./images/webhook-configured-permissions.png)
